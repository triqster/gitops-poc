# Override the fluent-bit dependency chart values
fluent-bit:
  # Dashboard configuration
  dashboards:
    enabled: true
    labelKey: grafana_dashboard
    labelValue: 1
    annotations: {}
    namespace: ""

  config:
    # Custom parser for CRI (Container Runtime Interface) format
    customParsers: |
      [PARSER]
          Name cri
          Format json
          Time_Keep Off
          Time_Key time
          Time_Format %Y-%m-%dT%H:%M:%S.%L

      [PARSER]
          Name docker_no_time
          Format json
          Time_Keep Off
          Time_Key time
          Time_Format %Y-%m-%dT%H:%M:%S.%L
  
      [PARSER]
          Name        cri-log
          Format      regex
          Regex       ^(?<time>[^ ]+) (?<stream>stdout|stderr) (?<logtag>[^ ]*) (?<log>.*)$
          Time_Key    time
          Time_Format %Y-%m-%dT%H:%M:%S.%L%z

      [PARSER]
          Name    k8s-custom-tag
          Format  regex
          Regex   (?<namespace_name>[^_]+)_(?<pod_name>[a-z0-9](?:[-a-z0-9]*[a-z0-9])?(?:\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*)_.+\.(?<container_name>.+)\.[0-9]+\.log$

      [PARSER]
          Name   auditlog-json
          Format json
          Time_Key time
          Time_Format %d/%b/%Y:%H:%M:%S %z

    # Service configuration
    service: |
      [SERVICE]
          Daemon Off
          Flush 1
          Log_Level info
          Parsers_File /fluent-bit/etc/parsers.conf
          Parsers_File /fluent-bit/etc/conf/custom_parsers.conf
          HTTP_Server On
          HTTP_Listen 0.0.0.0
          HTTP_Port 2020
          Health_Check On

    # Input configuration - tail container logs
    inputs: |
      [INPUT]
          Name tail
          Path /var/log/containers/*.log
          multiline.parser docker, cri
          Tag kube.*
          Mem_Buf_Limit 5MB
          Skip_Long_Lines On

    # Filter configuration - enrich with Kubernetes metadata
    filters: |
      [FILTER]
          Name kubernetes
          Match kube.services.*
          Kube_Tag_Prefix kube.services.var.log.containers.
          Merge_Log On
          Keep_Log Off
          K8S-Logging.Parser On
          K8S-Logging.Exclude On

    # Output configuration - forward to Elasticsearch
    outputs: |
      [OUTPUT]
          name stdout
          match *
